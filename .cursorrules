# ClipsAI-JP Code Review Rules

## プロジェクト概要
- パッケージ名: `clipsai_jp` (アンダースコア区切り)
- Python バージョン: >= 3.9
- コードフォーマッター: Black (line-length = 88)
- リンター: flake8
- テストフレームワーク: pytest

## コードレビューのチェックポイント

### 1. コーディングスタイル
- **Blackフォーマット**: すべてのコードはBlackでフォーマットされているか確認
- **行の長さ**: 最大88文字（Blackの設定に準拠）
- **flake8準拠**: E203, E502, W503, W504は無視されるが、その他のエラーは修正必須
- **インポート順序**: 
  - 標準ライブラリ
  - サードパーティライブラリ
  - ローカルパッケージ（`clipsai_jp`）
- **命名規則**: 
  - クラス名: PascalCase
  - 関数・変数名: snake_case
  - 定数: UPPER_SNAKE_CASE
  - プライベートメソッド: `_`で始まる

### 2. パッケージ構造
- **モジュール名**: `clipsai_jp`を使用（`clipsai`ではない）
- **インポートパス**: `from clipsai_jp.module import Class`の形式
- **テストのモック**: `clipsai_jp.`で始まるパスを使用（`clipsai.`ではない）

### 3. エラーハンドリング
- **カスタム例外**: `clipsai_jp`パッケージ内の例外クラスを使用
- **例外メッセージ**: 日本語または英語で明確なメッセージを提供
- **ログ出力**: `logging`モジュールを使用（`print`は避ける）

### 4. 型ヒント
- **型アノテーション**: 可能な限り型ヒントを追加
- **戻り値の型**: 関数の戻り値の型を明示
- **Optional/Union**: 適切に使用（Python 3.10+では`X | None`形式も可）

### 5. ドキュメント
- **docstring**: すべての公開クラス・関数にdocstringを追加
- **docstring形式**: NumPyスタイル（Parameters, Returnsセクションを使用）
- **パラメータ説明**: すべてのパラメータを説明（`Parameters`セクションで型と説明を記載）
- **戻り値の説明**: 戻り値の型と意味を説明（`Returns`セクションで記載）
- **使用例**: 複雑な関数には使用例を含める（`Notes`セクションを使用可）

### 6. テスト
- **テストカバレッジ**: 新機能には対応するテストを追加
- **テスト名**: `test_`で始まり、何をテストしているか明確に
- **テストの独立性**: 各テストは独立して実行可能
- **モックの使用**: 外部依存関係は適切にモック（パッチパスは`clipsai_jp.`で始める）
- **テストデータ**: テスト用のデータは`tests/`ディレクトリに配置
- **CI環境**: CI環境でもテストが正常に動作することを確認（NLTKリソースの自動ダウンロードなど）

### 7. 依存関係
- **NLTKリソース**: `punkt`と`punkt_tab`の両方をダウンロードする処理を含める
- **外部ライブラリ**: 新しい依存関係を追加する場合は`setup.py`に記載
- **バージョン制約**: 適切なバージョン制約を設定

### 8. パフォーマンス
- **不要な計算**: 重複する計算を避ける
- **メモリ使用**: 大きなデータ構造のコピーを避ける
- **I/O操作**: ファイル操作は適切にクローズ

### 9. セキュリティ
- **入力検証**: ユーザー入力は適切に検証
- **ファイルパス**: パストラバーサル攻撃を防ぐ
- **機密情報**: ハードコードされた認証情報を避ける

### 10. 互換性
- **後方互換性**: 既存のAPIを壊さない
- **Pythonバージョン**: Python 3.9以上で動作することを確認
- **プラットフォーム**: Windows、Mac、Linuxで動作することを確認

## コードレビュー時の確認事項

### 必須チェック
- [ ] Blackでフォーマットされている
- [ ] flake8エラーがない（E203, E502, W503, W504を除く）
- [ ] テストが追加されている（新機能の場合）
- [ ] すべてのテストがパスする
- [ ] docstringが追加されている（公開API）
- [ ] 型ヒントが追加されている
- [ ] `clipsai_jp`パッケージ名を使用している（`clipsai`ではない）

### 推奨チェック
- [ ] パフォーマンスの最適化が検討されている
- [ ] エラーハンドリングが適切
- [ ] ログ出力が適切
- [ ] コメントが適切に追加されている（複雑なロジック）
- [ ] 変数名が意味を持っている

### 禁止事項
- ❌ `clipsai`パッケージ名の使用（`clipsai_jp`を使用）
- ❌ `print`文の使用（`logging`を使用）
- ❌ ハードコードされた認証情報
- ❌ テストなしの新機能追加
- ❌ 既存のテストを壊す変更

## レビューコメントの書き方
- **建設的**: 問題点だけでなく、改善案も提示
- **具体的**: どの行に問題があるか明示
- **丁寧**: 日本語で丁寧に説明
- **優先度**: 必須修正と推奨改善を区別

## よくある問題と解決策

### 問題1: モジュール名の誤り
```python
# ❌ 間違い
from clipsai.media import VideoFile
patch("clipsai.utils.pytorch.get_free_cpu_memory")

# ✅ 正しい
from clipsai_jp.media import VideoFile
patch("clipsai_jp.utils.pytorch.get_free_cpu_memory")
```

### 問題2: NLTKリソースのダウンロード
```python
# ✅ 正しい実装
# NLTK 3.8以降ではpunkt_tabが必要だが、後方互換性のためpunktもダウンロード
try:
    nltk.download("punkt", quiet=True)
except Exception:
    pass
try:
    nltk.download("punkt_tab", quiet=True)
except Exception:
    pass
```

### 問題3: テストのモックパス
```python
# ❌ 間違い
with patch("clipsai.media.temporal_media_file.TemporalMediaFile.has_audio_stream"):

# ✅ 正しい
with patch("clipsai_jp.media.temporal_media_file.TemporalMediaFile.has_audio_stream"):
```

### 問題4: テストでのユーティリティモジュールのパッチパス
```python
# ❌ 間違い（utilsモジュールが見つからない）
with patch("utils.pytorch.get_free_cpu_memory", return_value=8000000000):

# ✅ 正しい
with patch("clipsai_jp.utils.pytorch.get_free_cpu_memory", return_value=8000000000):
```

## コードレビューの優先順位
1. **Critical**: セキュリティ問題、バグ、テスト失敗
2. **High**: パフォーマンス問題、APIの破壊的変更
3. **Medium**: コードスタイル、ドキュメント不足
4. **Low**: 改善提案、最適化の機会

